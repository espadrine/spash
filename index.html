<!doctype html><meta charset=utf-8><title> Spacetime Locator </title>
<style>
#noGeolocNode { display: none; }
</style>
<h1> Spash: Spacetime Locator </h1>
<output id=spashNode>Computing…</output><br>
<input type=button id=addDigitNode value='+'>
<input type=button id=rmDigitNode value='-'>
<input type=button id=editNode value='Edit'>
<p id=geolocNode></p>
<p id=precisionNode></p>
<p id=noGeolocNode>
  Your device does not allow access to geolocation data. Using a default location.
</p>
<p id=warningsNode></p>

<script src=./spash.js></script>
<script>
  var geoloc;
  var digits = 11;
  var setGeoloc = function(geo) {
    geoloc = geo;
    var sh = spash.encode(geo, digits);
    spashNode.value = sh.hash;
    showGeoloc();
    accuracyWarnings(sh, geo);
  };
  var noGeolocWarning = function() {
    noGeolocNode.style.display = 'block';
    var defaultGeo = {
      coords: {
        latitude: 51.5221656,
        longitude: -0.1086239,
        altitude: 22.725,
        accuracy: 2,
        altitudeAccuracy: 1e-9,
      },
    };
    setGeoloc(defaultGeo);
  };
  navigator.geolocation.getCurrentPosition(setGeoloc, noGeolocWarning, {
    enableHighAccuracy: true,
    timeout: 25000,
    maximumAge: 0
  });

  var showGeoloc = function() {
    geolocNode.innerHTML = [
      'Latitude: ' + geoloc.coords.latitude,
      'Longitude: ' + geoloc.coords.longitude,
      'Altitude: ' + geoloc.coords.altitude,
    ].join('<br>');
  };

  var accuracyWarnings = function(spash, geo) {
    var accuracies = [
      '± ' + spash.latError + ' meters (latitude)',
      '± ' + spash.longError + ' meters (longitude)',
      '± ' + spash.altError + ' meters (altitude)',
    ];
    precisionNode.innerHTML = accuracies.join('<br>');

    var geoAccuracy = geo.coords.accuracy || Infinity;  // meters
    var altAccuracy = (geo.coords.altitudeAccuracy) || Infinity;
    var warn = [];
    if (geoAccuracy > spash.longError || geoAccuracy > spash.latError) {
      warn.push('Geographic coordinates are not accurate enough for this level of precision.');
    }
    if (geo.coords.altitudeAccuracy === null) {
      warn.push('Altitude measurement unavailable; using sea level.');
    } else if (altAccuracy > spash.altError) {
      warn.push('Altitude measurement is not accurate enough for this level of precision.');
    }

    warningsNode.innerHTML = warn.join('<br>');
  };

  var addDigit = function(event) {
    digits++;
    setGeoloc(geoloc);
  };
  var rmDigit = function(event) {
    if (digits <= 0) { return; }
    digits--;
    setGeoloc(geoloc);
  };
  var edit = function(event) {
    var newSpash = prompt('Enter a spash.');
    setGeoloc(spash.decode(newSpash));
  };
  addDigitNode.addEventListener('click', addDigit);
  rmDigitNode.addEventListener('click', rmDigit);
  editNode.addEventListener('click', edit);
</script>
